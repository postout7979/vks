<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메인 페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
      .popup-chart {
        display: none; /* Initially hidden */
        position: absolute;
        width: 400px;
        height: 250px;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 1rem;
        z-index: 50;
      }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Avi LB 모니터링 시스템</h1>
        <div class="flex space-x-4">
            <a href="{{ url_for('dashboard') }}" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">대시보드 보기</a>
            <a href="{{ url_for('logout') }}" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">로그아웃</a>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-col">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Virtual Service 목록</h2>
        <table class="w-full text-left table-auto">
            <thead class="text-gray-600 uppercase text-sm leading-normal bg-gray-200">
                <tr>
                    <th class="py-3 px-6 text-left">VirtualService 이름</th>
                </tr>
            </thead>
            <tbody id="vs-list-body" class="text-gray-600 text-sm font-light">
                <!-- 데이터가 여기에 동적으로 삽입됩니다 -->
            </tbody>
        </table>
        <p id="loading-message" class="text-center text-gray-500 text-lg mt-4">데이터를 불러오는 중입니다...</p>
    </div>

    <!-- 팝업 차트 컨테이너 -->
    <div id="popup-chart-container" class="popup-chart">
        <canvas id="popup-chart-canvas"></canvas>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let charts = {};
            let performanceData = [];

            const popupChartContainer = document.getElementById('popup-chart-container');
            const popupChartCanvas = document.getElementById('popup-chart-canvas').getContext('2d');
            let popupChartInstance = null;

            async function fetchAllData() {
                try {
                    const vsApiUrl = window.location.origin + '/api/virtualservices';
                    const performanceApiUrl = window.location.origin + '/api/performance';

                    const [vsResponse, performanceResponse] = await Promise.all([
                        fetch(vsApiUrl),
                        fetch(performanceApiUrl)
                    ]);

                    if (vsResponse.status === 401 || performanceResponse.status === 401) {
                        window.location.href = "{{ url_for('login') }}";
                        return;
                    }

                    const vsData = await vsResponse.json();
                    const perfData = await performanceResponse.json();
                    performanceData = perfData.results || [];

                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        loadingMessage.style.display = 'none';
                    }

                    const vsListBody = document.getElementById('vs-list-body');
                    vsListBody.innerHTML = '';

                    if (vsData && vsData.results && vsData.results.length > 0) {
                        vsData.results.forEach(vs => {
                            const row = document.createElement('tr');
                            row.className = 'border-b border-gray-200 hover:bg-gray-100 cursor-pointer';
                            row.setAttribute('data-vs-name', vs.name);

                            const nameCell = document.createElement('td');
                            nameCell.className = 'py-3 px-6 text-left whitespace-nowrap';
                            nameCell.textContent = vs.name;
                            
                            row.appendChild(nameCell);
                            vsListBody.appendChild(row);

                            // 마우스 이벤트 리스너 추가
                            row.addEventListener('mouseover', (e) => showPopupChart(vs.name, e));
                            row.addEventListener('mouseout', hidePopupChart);
                        });
                    } else {
                        vsListBody.innerHTML = '<tr><td colspan="1" class="py-3 px-6 text-center">데이터가 없습니다.</td></tr>';
                    }

                } catch (error) {
                    console.error('Error fetching data:', error);
                    const vsListBody = document.getElementById('vs-list-body');
                    vsListBody.innerHTML = '<tr><td colspan="1" class="py-3 px-6 text-center text-red-500">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
                }
            }

            function showPopupChart(vsName, event) {
                const vsData = performanceData.find(d => d.name === vsName);
                if (!vsData || !vsData.series || vsData.series.length === 0) {
                    return; // 데이터가 없으면 차트를 표시하지 않음
                }

                const bandwidthData = vsData.series[0].data;
                const labels = bandwidthData.map(d => new Date(d.timestamp).toLocaleTimeString());
                const values = bandwidthData.map(d => (d.value / 1000).toFixed(2));
                
                const datasets = [{
                    label: `${vsName} 대역폭`,
                    data: values,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }];

                if (popupChartInstance) {
                    popupChartInstance.data.labels = labels;
                    popupChartInstance.data.datasets = datasets;
                    popupChartInstance.update();
                } else {
                    popupChartInstance = new Chart(popupChartCanvas, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                x: {
                                    display: false
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: '대역폭 (kbps)'
                                    },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                // 팝업 위치 설정
                popupChartContainer.style.left = `${event.pageX + 10}px`;
                popupChartContainer.style.top = `${event.pageY + 10}px`;
                popupChartContainer.style.display = 'block';
            }

            function hidePopupChart() {
                popupChartContainer.style.display = 'none';
            }
            
            fetchAllData();
            setInterval(fetchAllData, 5000);
        });
    </script>
</body>
</html>

