<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avi LB 성능 모니터링</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
      .chart-card {
        min-height: 400px;
        /* Dynamic height adjustment for chart cards */
        height: calc(50vh - 150px);
      }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Avi LB 성능 모니터링</h1>
        <div class="flex space-x-4">
            <!-- HOME 버튼 추가 -->
            <a href="{{ url_for('index') }}" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">HOME</a>
            <a href="{{ url_for('logout') }}" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">로그아웃</a>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg mb-6 flex flex-col items-center">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">전체 VirtualService 대역폭 총합</h2>
        <div class="relative w-full text-center mb-4">
             <span id="total-bandwidth-display" class="text-4xl font-bold text-gray-800">0 kbps</span>
        </div>
    </div>

    <div id="chart-list" class="grid grid-cols-1 gap-6">
        <!-- Chart.js 차트들이 여기에 동적으로 생성됩니다. -->
        <p id="loading-message" class="text-center text-gray-500 text-lg">데이터를 불러오는 중입니다...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let charts = {}; // Store chart instances
            const colors = [
                'rgb(75, 192, 192)',
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(153, 102, 255)',
                'rgb(201, 203, 207)',
                'rgb(255, 159, 64)'
            ];
            // Arrays to store historical data for the total bandwidth chart
            let totalBandwidthHistory = [];
            let totalBandwidthTimestamps = [];

            async function initializeDashboard() {
                try {
                    const apiUrl = window.location.origin + '/api/performance';
                    const response = await fetch(apiUrl);
                    
                    if (response.status === 401) {
                        window.location.href = "{{ url_for('login') }}";
                        return;
                    }

                    const data = await response.json();
                    
                    const loadingMessage = document.getElementById('loading-message');
                    if (loadingMessage) {
                        loadingMessage.style.display = 'none';
                    }
                    
                    if (data && data.results && data.results.length > 0) {
                        const chartList = document.getElementById('chart-list');
                        
                        // Logic for the combined VirtualService chart (same as before)
                        const datasets = data.results.map((vsData, index) => {
                            const name = vsData.name;
                            const bandwidthData = vsData.series && vsData.series.length > 0 ? vsData.series[0].data : [];
                            const values = bandwidthData.map(d => (d.value / 1000).toFixed(2));

                            return {
                                label: name,
                                data: values,
                                borderColor: colors[index % colors.length],
                                tension: 0.1,
                                fill: false
                            };
                        });
                        
                        const allTimestamps = data.results.flatMap(vsData => 
                            vsData.series && vsData.series.length > 0 ? vsData.series[0].data.map(d => d.timestamp) : []
                        ).sort((a, b) => a - b);
                        const uniqueLabels = [...new Set(allTimestamps)].map(ts => new Date(ts).toLocaleTimeString());

                        updateOrCreateChart('combined-chart', 'VirtualService L4 클라이언트 대역폭', uniqueLabels, datasets);

                        // Logic for the new total bandwidth trend chart
                        const totalBandwidth = data.results.reduce((sum, vsData) => {
                            if (vsData.series && vsData.series.length > 0 && vsData.series[0].data.length > 0) {
                                return sum + (vsData.series[0].data[vsData.series[0].data.length - 1].value);
                            }
                            return sum;
                        }, 0);
                        updateTotalBandwidthDisplay(totalBandwidth);

                        const currentTime = new Date().toLocaleTimeString();
                        totalBandwidthHistory.push((totalBandwidth / 1000).toFixed(2));
                        totalBandwidthTimestamps.push(currentTime);

                        // Limit the number of data points for the trend chart
                        const maxDataPoints = 20;
                        if (totalBandwidthHistory.length > maxDataPoints) {
                            totalBandwidthHistory.shift();
                            totalBandwidthTimestamps.shift();
                        }

                        const totalBandwidthDatasets = [{
                            label: '전체 대역폭',
                            data: totalBandwidthHistory,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            fill: false,
                            pointStyle: 'circle',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }];

                        updateOrCreateChart('total-bandwidth', '전체 VirtualService 대역폭 추세', totalBandwidthTimestamps, totalBandwidthDatasets);

                    } else {
                        document.getElementById('chart-list').innerHTML = 
                            '<p class="text-center text-gray-500 text-lg">데이터가 없습니다.</p>';
                    }

                } catch (error) {
                    console.error('Error initializing dashboard:', error);
                    document.getElementById('chart-list').innerHTML = 
                        '<p class="text-center text-red-500 text-lg">대시보드 초기화 중 오류가 발생했습니다.</p>';
                }
            }

            function updateOrCreateChart(id, title, labels, datasets) {
                const chartList = document.getElementById('chart-list');
                let chartCard = document.getElementById(`card-${id}`);
                let chartInstance = charts[id];

                if (!chartCard) {
                    chartCard = document.createElement('div');
                    chartCard.id = `card-${id}`;
                    chartCard.className = 'bg-white p-6 rounded-lg shadow-lg chart-card';
                    chartCard.innerHTML = `
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">${title}</h2>
                        <canvas id="chart-${id}"></canvas>
                    `;
                    // Prepend the new card to the list so the trend chart appears first
                    chartList.prepend(chartCard);
                }

                if (chartInstance) {
                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets = datasets;
                    chartInstance.update();
                } else {
                    const ctx = document.getElementById(`chart-${id}`).getContext('2d');
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // Prevents Chart.js from overriding the aspect ratio
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: '시간'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: '대역폭 (kbps)'
                                    },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    charts[id] = chartInstance;
                }
            }

            function updateTotalBandwidthDisplay(totalBps) {
                const totalKbps = (totalBps / 1000).toFixed(2);
                document.getElementById('total-bandwidth-display').textContent = `${totalKbps} kbps`;
            }

            initializeDashboard();
            setInterval(initializeDashboard, 5000);
        });
    </script>
</body>
</html>

