<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avi Monitor 통합 차트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- 로딩 오버레이 -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
    </div>

    <!-- 메시지 박스 -->
    <div id="message-box" class="message-box hidden">
        <p id="message-text" class="text-gray-700"></p>
        <button onclick="hideMessageBox()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">확인</button>
    </div>

    <!-- 헤더 -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center">
            <a href="/" class="text-gray-500 hover:text-gray-700 mr-4">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-2xl font-bold text-gray-800">통합 성능 차트</h1>
        </div>
        <div class="flex items-center">
            <span id="auth-status" class="text-sm font-medium text-gray-600 mr-4">로그인되지 않음</span>
            <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors hidden">
                로그아웃
            </button>
        </div>
    </header>

    <!-- 메인 컨테이너 -->
    <main class="flex-grow p-4 md:p-8 mt-20">
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <div class="flex items-center mb-4 justify-between">
                <h2 class="text-2xl font-bold text-gray-800">모든 Virtual Service 통합 성능</h2>
                <div class="flex items-center">
                    <label for="time-range" class="text-gray-700 mr-2">시간 범위:</label>
                    <select id="time-range" class="border rounded-md p-2">
                        <option value="10">10분</option>
                        <option value="30">30분</option>
                        <option value="60">1시간</option>
                        <option value="1440">1일</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <canvas id="totalBandwidthChart"></canvas>
                </div>
                <div>
                    <canvas id="totalConnectionsChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <footer class="bg-gray-800 text-white p-4 text-center mt-auto">
        <p>&copy; 2025 TKG SME Group in KOREA. All rights reserved.</p>
    </footer>

    <script>
        // 전역 변수
        let totalBandwidthChart = null;
        let totalConnectionsChart = null;
        const apiBaseUrl = '/api';

        // DOM 요소
        const loadingOverlay = document.getElementById('loading-overlay');
        const timeRangeSelect = document.getElementById('time-range');
        const authStatus = document.getElementById('auth-status');
        const logoutButton = document.getElementById('logout-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // 메시지 박스 표시 함수
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // 메시지 박스 숨기기 함수
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        // 로딩 상태 표시/숨기기
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // API 호출 도우미 함수
        async function fetchAPI(url, options = {}) {
            showLoading();
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 401) {
                        showMessageBox('세션이 만료되었습니다. 다시 로그인해 주세요.');
                        // 로그인 페이지로 리디렉션
                        window.location.href = '/'; 
                        return null;
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error("API 호출 오류:", error);
                showMessageBox(`API 호출 실패: ${error.message}`);
                return null;
            } finally {
                hideLoading();
            }
        }

        // 로그아웃 버튼 이벤트
        logoutButton.addEventListener('click', async () => {
            const result = await fetchAPI(`${apiBaseUrl}/logout`, { method: 'POST' });
            if (result && result.success) {
                showMessageBox(result.message);
                window.location.href = '/'; 
            } else {
                showMessageBox('로그아웃 실패');
            }
        });

        // 초기 로그인 상태 확인
        async function checkLoginStatus() {
            const status = await fetchAPI(`${apiBaseUrl}/check_login_status`);
            if (status && status.is_logged_in) {
                authStatus.textContent = '로그인됨';
                logoutButton.classList.remove('hidden');
            } else {
                authStatus.textContent = '로그인되지 않음';
                logoutButton.classList.add('hidden');
                // 로그인되어 있지 않으면 대시보드로 리디렉션
                window.location.href = '/';
            }
        }

        // 통합 성능 데이터 가져오기 및 그래프 업데이트
        async function fetchAllPerformanceData(duration) {
            const performanceData = await fetchAPI(`${apiBaseUrl}/performance?duration_minutes=${duration}`);
            if (performanceData && performanceData.results.length > 0) {
                updateCombinedCharts(performanceData.results);
            } else {
                showMessageBox('선택된 시간 범위의 통합 성능 데이터를 가져오지 못했습니다.');
                if (totalBandwidthChart) totalBandwidthChart.destroy();
                if (totalConnectionsChart) totalConnectionsChart.destroy();
            }
        }

        // 통합 차트 업데이트 함수
        function updateCombinedCharts(data) {
            const aggregatedData = {};

            // 모든 VS의 데이터를 timestamp별로 집계
            data.forEach(vs => {
                vs.series.forEach(series => {
                    const metricName = series.header.name;
                    series.data.forEach(point => {
                        const timestamp = new Date(point.timestamp).toISOString();
                        if (!aggregatedData[timestamp]) {
                            aggregatedData[timestamp] = {};
                        }
                        if (!aggregatedData[timestamp][metricName]) {
                            aggregatedData[timestamp][metricName] = 0;
                        }
                        aggregatedData[timestamp][metricName] += point.value;
                    });
                });
            });

            const labels = Object.keys(aggregatedData).sort();
            const aggregatedBandwidth = labels.map(ts => aggregatedData[ts]['l4_client.avg_bandwidth'] || 0);
            const aggregatedConnections = labels.map(ts => aggregatedData[ts]['l4_server.avg_open_conns'] || 0);
            
            const displayLabels = labels.map(ts => new Date(ts).toLocaleTimeString());

            // Chart.js 인스턴스가 이미 존재하면 파괴
            if (totalBandwidthChart) totalBandwidthChart.destroy();
            if (totalConnectionsChart) totalConnectionsChart.destroy();

            // 통합 대역폭 차트
            totalBandwidthChart = new Chart(document.getElementById('totalBandwidthChart'), {
                type: 'line',
                data: {
                    labels: displayLabels,
                    datasets: [{
                        label: '통합 평균 대역폭 (bps)',
                        data: aggregatedBandwidth,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '통합 평균 대역폭'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'bps'
                            }
                        }
                    }
                }
            });

            // 통합 연결 수 차트
            totalConnectionsChart = new Chart(document.getElementById('totalConnectionsChart'), {
                type: 'line',
                data: {
                    labels: displayLabels,
                    datasets: [{
                        label: '통합 평균 동시 연결 수',
                        data: aggregatedConnections,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '통합 평균 동시 연결 수'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '연결 수'
                            }
                        }
                    }
                }
            });
        }

        // 시간 범위 선택 변경 이벤트
        timeRangeSelect.addEventListener('change', (e) => {
            const duration = e.target.value;
            fetchAllPerformanceData(duration);
        });

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
            const initialDuration = timeRangeSelect.value;
            fetchAllPerformanceData(initialDuration);
        });
    </script>
</body>
</html>

