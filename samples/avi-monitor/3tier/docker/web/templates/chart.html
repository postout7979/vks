<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avi LB 성능 차트 조회</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* 팝업 모달 오버레이 */
        #chartPopupModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }
        /* 팝업 모달 컨텐츠 */
        #chartPopupContent {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 960px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        /* 차트 컨테이너 */
        #chartContainer {
            position: relative;
            height: 50vh;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        /* 차트 로딩 상태 */
        .chart-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div id="loading-message" class="text-center text-gray-500 hidden">데이터를 로드하는 중...</div>
    <div id="no-data-message" class="text-center text-gray-500 hidden">데이터가 없습니다.</div>
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h1 id="chart-title" class="text-2xl font-bold text-gray-800">VS 성능 차트</h1>
            <div class="flex items-center space-x-4">
                <button id="expandChartBtn" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-300 transition-colors">확대</button>
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <input type="radio" id="bandwidth-radio" name="metric-select" class="hidden" checked>
                    <label for="bandwidth-radio" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 cursor-pointer">
                        대역폭
                    </label>
                    <input type="radio" id="connections-radio" name="metric-select" class="hidden">
                    <label for="connections-radio" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 cursor-pointer">
                        연결 수
                    </label>
                </div>
            </div>
        </div>
        
        <div id="chartContainer">
            <canvas id="performanceChart"></canvas>
            <div id="chartLoading" class="chart-loading hidden">
                <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- 확대 차트 모달 -->
    <div id="chartPopupModal" class="hidden">
        <div id="chartPopupContent">
            <div class="flex justify-between items-center mb-4">
                <h2 id="popupTitle" class="text-2xl font-bold">VS 성능 차트 (확대)</h2>
                <button id="closePopupBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="popupChartContainer" class="relative" style="height: 70vh;">
                <canvas id="popupChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const vsUuid = urlParams.get('vs_uuid');
        const vsName = urlParams.get('vs_name');
        
        const chartTitleEl = document.getElementById('chart-title');
        const performanceChartCanvas = document.getElementById('performanceChart');
        const chartLoading = document.getElementById('chartLoading');
        const noDataMessage = document.getElementById('no-data-message');
        const bandwidthRadio = document.getElementById('bandwidth-radio');
        const connectionsRadio = document.getElementById('connections-radio');
        const expandChartBtn = document.getElementById('expandChartBtn');

        let performanceChart = null;
        let activeMetricId = 'l4_client_bytes_in';
        let refreshIntervalId = null;

        // URL 파라미터가 없으면 에러 메시지 표시
        if (!vsUuid || !vsName) {
            chartTitleEl.textContent = '잘못된 접근입니다.';
        } else {
            chartTitleEl.textContent = `${vsName} 성능 차트`;
            startChartRefresh();
        }

        /**
         * @description 차트 데이터를 가져와 렌더링을 시작합니다.
         */
        function startChartRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
            }
            fetchChartDataAndRender();
            refreshIntervalId = setInterval(fetchChartDataAndRender, 5000);
        }

        /**
         * @description API를 호출하여 차트 데이터를 가져와 차트를 렌더링합니다.
         */
        async function fetchChartDataAndRender() {
            if (!vsUuid) return;

            chartLoading.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            try {
                const response = await fetch(`/api/vs_performance/history?vs_uuid=${vsUuid}&metric_id=${activeMetricId}`);
                if (!response.ok) throw new Error('Chart data fetch failed');
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    renderChart(performanceChartCanvas, data.results, activeMetricId);
                    expandChartBtn.disabled = false;
                } else {
                    if (performanceChart) {
                        performanceChart.destroy();
                        performanceChart = null;
                    }
                    noDataMessage.textContent = '데이터가 없습니다.';
                    noDataMessage.classList.remove('hidden');
                    expandChartBtn.disabled = true;
                }

            } catch (error) {
                console.error('차트 데이터 로딩 실패:', error);
                if (performanceChart) {
                    performanceChart.destroy();
                    performanceChart = null;
                }
                noDataMessage.textContent = '데이터를 불러오는 데 실패했습니다.';
                noDataMessage.classList.remove('hidden');
                expandChartBtn.disabled = true;
            } finally {
                chartLoading.classList.add('hidden');
            }
        }

        /**
         * @description 단일 차트를 렌더링하는 헬퍼 함수
         */
        function renderChart(canvas, seriesData, metricId) {
            // 기존 차트가 있으면 제거
            if (performanceChart) {
                performanceChart.destroy();
            }

            const chartLabel = metricId === 'l4_client_bytes_in' ? '대역폭 (kbps)' : '연결 수';
            const unit = metricId === 'l4_client_bytes_in' ? 'kbps' : '';

            // 데이터를 시간순으로 정렬
            seriesData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            const chartData = {
                labels: seriesData.map(d => moment(d.timestamp)),
                datasets: [{
                    label: chartLabel,
                    data: seriesData.map(d => metricId === 'l4_client_bytes_in' ? (d.value / 1000).toFixed(2) : d.value),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            };

            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                tooltipFormat: 'YYYY-MM-DD HH:mm:ss',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: '시간'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: chartLabel
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' ' + unit;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };
            
            performanceChart = new Chart(canvas, config);
        }

        // --- 이벤트 리스너 ---
        bandwidthRadio.addEventListener('change', () => {
            activeMetricId = 'l4_client_bytes_in';
            startChartRefresh();
        });

        connectionsRadio.addEventListener('change', () => {
            activeMetricId = 'l4_client_new_connections';
            startChartRefresh();
        });

        expandChartBtn.addEventListener('click', () => {
            // 팝업 모달 열기
            document.getElementById('chartPopupModal').classList.remove('hidden');
            const popupChartCanvas = document.getElementById('popupChartCanvas');
            const popupChartCtx = popupChartCanvas.getContext('2d');
            
            // 확대된 차트 렌더링
            const chartLabel = activeMetricId === 'l4_client_bytes_in' ? '대역폭 (kbps)' : '연결 수';
            const unit = activeMetricId === 'l4_client_bytes_in' ? 'kbps' : '';

            // 기존 차트 데이터 가져오기
            const chartData = performanceChart.data;
            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                tooltipFormat: 'YYYY-MM-DD HH:mm:ss',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: '시간'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: chartLabel
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' ' + unit;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };
            
            new Chart(popupChartCtx, config);
        });

        document.getElementById('closePopupBtn').addEventListener('click', () => {
            document.getElementById('chartPopupModal').classList.add('hidden');
        });

    </script>
</body>
</html>

